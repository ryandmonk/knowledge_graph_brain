kb_id: slack-kb
name: Slack Knowledge Base
description: Slack messages, channels, threads, and user interactions
embedding:
  provider: "ollama:mxbai-embed-large"
  chunking:
    strategy: "paragraph"
    max_tokens: 1000

schema:
  nodes:
    - label: SlackMessage
      key: ts
      props: [ts, text, content, user, channel, thread_ts, reply_count, reactions, type, subtype, permalink, files, attachments, blocks, edited, pinned_to]
    
    - label: SlackChannel
      key: id  
      props: [id, name, name_normalized, topic, purpose, is_archived, is_channel, is_group, is_im, is_mpim, is_private, is_general, is_member, is_shared, creator, created, num_members, members, latest]
    
    - label: SlackUser
      key: id
      props: [id, name, real_name, display_name, profile, is_admin, is_owner, is_primary_owner, is_restricted, is_ultra_restricted, is_bot, updated, has_2fa, locale, tz, tz_label, tz_offset]
    
    - label: SlackFile
      key: id
      props: [id, name, title, mimetype, filetype, pretty_type, user, created, timestamp, size, is_external, is_public, url_private, url_private_download, thumb_64, thumb_80, thumb_360, permalink, channels, groups, ims, comments_count]

  relationships:
    - type: POSTED_IN
      from: SlackMessage
      to: SlackChannel
    
    - type: POSTED_BY
      from: SlackMessage
      to: SlackUser
    
    - type: REPLIED_TO
      from: SlackMessage
      to: SlackMessage
    
    - type: MEMBER_OF
      from: SlackUser
      to: SlackChannel
    
    - type: CREATED_BY
      from: SlackChannel
      to: SlackUser
    
    - type: UPLOADED_BY
      from: SlackFile
      to: SlackUser
    
    - type: ATTACHED_TO
      from: SlackFile
      to: SlackMessage

mappings:
  sources:
    - source_id: "slack-messages"
      connector_url: "http://localhost:3003/pull"  
      document_type: "slack_message"
      extract:
        node: "SlackMessage"
        assign:
          ts: "$.ts"
          text: "$.text"
          content: "$.text"
          user: "$.user"
          channel: "$.channel"
          thread_ts: "$.thread_ts"
          reply_count: "$.reply_count"
          reactions: "$.reactions"
          type: "$.type"
          subtype: "$.subtype"
          permalink: "$.permalink"
          files: "$.files"
          attachments: "$.attachments"
          blocks: "$.blocks"
          edited: "$.edited"
          pinned_to: "$.pinned_to"
      edges:
        - type: POSTED_IN
          from: 
            node: "SlackMessage"
            key: "$.ts"
          to:
            node: SlackChannel
            key: "$.channel"
            props:
              id: "$.channel"
              name: "$.channel_name"
        - type: POSTED_BY
          from: 
            node: "SlackMessage"
            key: "$.ts"
          to:
            node: SlackUser
            key: "$.user"
            props:
              id: "$.user"
              name: "$.username"
              real_name: "$.user_profile.real_name"
        - type: REPLIED_TO
          from: 
            node: "SlackMessage"
            key: "$.ts"
          to:
            node: SlackMessage
            key: "$.thread_ts"
            condition: "$.thread_ts != null && $.thread_ts != $.ts"
        - type: ATTACHED_TO
          from: 
            node: "SlackFile"
            key: "$.files[*].id"
          to:
            node: SlackMessage
            key: "$.ts"
            condition: "$.files != null && $.files.length > 0"
